---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: SmokeTests
      ansible.builtin.debug:
        msg:
          - "ansible_version => {{ansible_version}}"
          - "ansible_distribution => {{ ansible_distribution }}"
          - "ansible_distribution_major_version => {{ ansible_distribution_major_version }}"
          - "ansible_os_family  => {{ ansible_os_family}}"
          - "ansible_system  => {{ ansible_system }}"

    - name: Check envoy group
      ansible.builtin.group:
        name: "envoy"
        state: present
      check_mode: true
      register: verify_envoy_group
      failed_when: (verify_envoy_group is changed) or (verify_envoy_group is failed)

    - name: Check envoy user
      ansible.builtin.user:
        name: "envoy"
        group: "envoy"
        comment: "envoy proxy"
        system: "true"
        createhome: false
        shell: "/sbin/nologin"
        state: present
      check_mode: true
      register: verify_envoy_user
      failed_when: (verify_envoy_user is changed) or (verify_envoy_user is failed)

    - name: check envoy conf directory
      ansible.builtin.file:
        path: "/etc/envoy"
        state: directory
        owner: "envoy"
        group: "envoy"
        mode: "0750"
      check_mode: true
      register: verify_envoy_conf_folder
      failed_when: (verify_envoy_conf_folder is changed) or (verify_envoy_conf_folder is failed)

    - name: Check if envoy installed
      ansible.builtin.stat:
        path: "/usr/local/bin/envoy"
      check_mode: true
      register: verify_envoy_is_installed
      failed_when: not verify_envoy_is_installed.stat.exists

    - name: check envoy systemd service file
      ansible.builtin.lineinfile:
        name: "/etc/systemd/system/envoy.service"
        line: "# Ansible managed: Do NOT edit this file manually!"
        state: present
        owner: "root"
        group: "root"
        mode: "0644"
      check_mode: true
      register: verify_envoy_systemd
      failed_when: (verify_envoy_systemd is changed) or (verify_envoy_systemd is failed)

    - name: check envoy config file
      ansible.builtin.lineinfile:
        name: "/etc/envoy/envoy.yaml"
        line: "# Ansible managed: Do NOT edit this file manually!"
        state: present
        owner: "envoy"
        group: "envoy"
        mode: "0640"
      check_mode: true
      register: verify_envoy_config
      failed_when: (verify_envoy_config is changed) or (verify_envoy_config is failed)

    - name: check envoy daemon
      ansible.builtin.service:
        name: "envoy"
        state: started
        enabled: true
      check_mode: true
      register: verify_envoy_service
      failed_when: (verify_envoy_service is changed) or (verify_envoy_service is failed)
